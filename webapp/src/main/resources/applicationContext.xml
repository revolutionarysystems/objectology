<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd
		http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd">

    <import resource="securityContext.xml"/>
    
    <context:annotation-config/>
    
    <bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
        <property name="locations">
            <list>
                <value>classpath:objectology.properties</value>
            </list>
        </property>
    </bean>
	
    <bean class="org.apache.wink.spring.Registrar">
        <property name="classes">
            <set value-type="java.lang.Class"/>
        </property>
        <property name="instances">
            <set>
                <bean class="uk.co.revsys.objectology.service.rest.TemplateRestService">
                    <constructor-arg index="0" ref="templateService"/>
                    <constructor-arg index="1" ref="templateLoader"/>
                    <constructor-arg index="2" ref="xmlObjectMapper"/>
                    <constructor-arg index="3" ref="jsonTemplateMapper"/>
                    <constructor-arg index="4" ref="templateViewMap"/>
                    <constructor-arg index="5" ref="authorisationHandler"/>
                </bean>
                <bean class="uk.co.revsys.objectology.service.rest.InstanceRestService">
                    <constructor-arg index="0" ref="instanceService"/>
                    <constructor-arg index="1" ref="xmlObjectMapper"/>
                    <constructor-arg index="2" ref="jsonInstanceMapper"/>
                    <constructor-arg index="3" ref="instanceViewMap"/>
                    <constructor-arg index="4" ref="authorisationHandler"/>
                    <constructor-arg index="5" ref="actionHandlerFactory"/>
                </bean>
            </set>
        </property>
    </bean>
	
    <bean id="templateService" class="uk.co.revsys.objectology.service.OlogyTemplateServiceImpl">
        <constructor-arg index="0" ref="templateDao"/>
        <constructor-arg index="1" ref="templateValidator"/>
    </bean>
	
    <bean id="instanceService" class="uk.co.revsys.objectology.service.OlogyInstanceServiceImpl">
        <constructor-arg index="0" ref="instanceDaoFactory"/>
        <constructor-arg index="1" ref="instanceValidator"/>
    </bean>
	
    <!--bean id="templateDao" class="uk.co.revsys.objectology.dao.InMemoryOlogyObjectDao"/-->
	
    <!--bean id="instanceDaoFactory" class="uk.co.revsys.objectology.dao.InMemoryOlogyObjectDaoFactory"/-->
	
    <bean id="templateDao" class="uk.co.revsys.objectology.dao.mongo.MongoDao">
        <constructor-arg index="0" ref="mongoClient"/>
        <constructor-arg index="1" value="${db.name}"/>
        <constructor-arg index="2" value="uk.co.revsys.objectology.model.template.OlogyTemplate"/>
        <constructor-arg index="3" ref="jsonTemplateMapper"/>
        <constructor-arg index="4" value="template"/>
    </bean>
	
    <bean id="instanceDaoFactory" class="uk.co.revsys.objectology.dao.mongo.MongoDaoFactory">
        <constructor-arg index="0" ref="mongoClient"/>
        <constructor-arg index="1" value="${db.name}"/>
        <constructor-arg index="2" ref="jsonDBInstanceMapper"/>
        <constructor-arg index="3" value="uk.co.revsys.objectology.model.instance.OlogyInstance"/>
    </bean>
	
    <bean id="mongoClient" class="com.mongodb.MongoClient">
        <constructor-arg index="0" value="${db.host}"/>
    </bean>
	
    <bean id="templateValidator" class="uk.co.revsys.objectology.service.OlogyTemplateValidator"/>
	
    <bean id="instanceValidator" class="uk.co.revsys.objectology.service.OlogyInstanceValidator"/>
	
    <bean id="xmlObjectMapper" class="uk.co.revsys.objectology.mapping.xml.XMLObjectMapper">
        <constructor-arg index="0" ref="xmlTemplateToJSONConverter"/>
        <constructor-arg index="1" ref="xmlInstanceToJSONConverter"/>
        <constructor-arg index="2" ref="jsonTemplateMapper"/>
        <constructor-arg index="3" ref="jsonInstanceMapper"/>
    </bean>
    
    <bean id="xmlTemplateToJSONConverter" class="uk.co.revsys.objectology.mapping.xml.XMLTemplateToJSONConverter"/>
    
    <bean id="xmlInstanceToJSONConverter" class="uk.co.revsys.objectology.mapping.xml.XMLInstanceToJSONConverter">
        <constructor-arg index="0" ref="templateService"/>
    </bean>
	
    <bean id="jsonInstanceMapper" class="uk.co.revsys.objectology.mapping.json.JsonInstanceMapper">
        <constructor-arg index="0" ref="sequenceGenerator"/>
    </bean>
    
    <bean id="jsonDBInstanceMapper" class="uk.co.revsys.objectology.mapping.json.JsonDBInstanceMapper"/>
	
    <bean id="jsonTemplateMapper" class="uk.co.revsys.objectology.mapping.json.JsonTemplateMapper">
    </bean>
	
    <bean id="templateViewMap" class="uk.co.revsys.objectology.view.DefaultTemplateViewMap"/>
	
    <bean id="instanceViewMap" class="uk.co.revsys.objectology.view.DefaultInstanceViewMap"/>
    
    <bean id="templateProvider" class="uk.co.revsys.resource.repository.provider.ResourceProvider">
        <constructor-arg index="0" ref="templateRepository"/>
        <constructor-arg index="1" value="${template.path}"/>
        <constructor-arg index="2" ref="xmlFilter"/>
        <constructor-arg index="3" ref="templateLoader"/>
    </bean>
    
    <bean id="instanceProvider" class="uk.co.revsys.resource.repository.provider.ResourceProvider">
        <constructor-arg index="0" ref="instanceRepository"/>
        <constructor-arg index="1" value="${instance.path}"/>
        <constructor-arg index="2" ref="xmlFilter"/>
        <constructor-arg index="3" ref="instanceLoader"/>
    </bean>
    
    <bean id="resourceRepositoryFactory" class="uk.co.revsys.resource.repository.ResourceRepositoryFactory">
        <constructor-arg index="0">
            <map key-type="java.lang.String" value-type="uk.co.revsys.resource.repository.ResourceRepositoryBuilder">
                <entry key="template-local" value-ref="localDiskTemplateRepositoryBuilder"/>
                <entry key="template-cloud" value-ref="cloudTemplateRepositoryBuilder"/>
                <entry key="instance-local" value-ref="localDiskInstanceRepositoryBuilder"/>
                <entry key="instance-cloud" value-ref="cloudInstanceRepositoryBuilder"/>
            </map>
        </constructor-arg>
    </bean>
    
    <bean id="localDiskTemplateRepositoryBuilder" class="uk.co.revsys.resource.repository.LocalDiskResourceRepositoryBuilder">
        <constructor-arg index="0" value="${template.container}"/>
    </bean>
    
    <bean id="cloudTemplateRepositoryBuilder" class="uk.co.revsys.resource.repository.cloud.JCloudResourceRepositoryBuilder">
        <constructor-arg index="0" value="${cloud.type}"/>
        <constructor-arg index="1" value="${cloud.identity}"/>
        <constructor-arg index="2" value="${cloud.credential}"/>
        <constructor-arg index="3" value="${template.container}"/>
    </bean>
	
    <bean id="templateRepository" factory-bean="resourceRepositoryFactory" factory-method="build">
        <constructor-arg index="0" value="template-${template.repository.type}"/>
    </bean>
    
    <bean id="localDiskInstanceRepositoryBuilder" class="uk.co.revsys.resource.repository.LocalDiskResourceRepositoryBuilder">
        <constructor-arg index="0" value="${instance.container}"/>
    </bean>
    
    <bean id="cloudInstanceRepositoryBuilder" class="uk.co.revsys.resource.repository.cloud.JCloudResourceRepositoryBuilder">
        <constructor-arg index="0" value="${cloud.type}"/>
        <constructor-arg index="1" value="${cloud.identity}"/>
        <constructor-arg index="2" value="${cloud.credential}"/>
        <constructor-arg index="3" value="${instance.container}"/>
    </bean>
	
    <bean id="instanceRepository" factory-bean="resourceRepositoryFactory" factory-method="build">
        <constructor-arg index="0" value="instance-${instance.repository.type}"/>
    </bean>
    
    <bean id="xmlFilter" class="uk.co.revsys.resource.repository.provider.filter.ExtensionFilter">
        <constructor-arg index="0" value=".xml"/>
    </bean>
    
    <bean id="templateLoader" class="uk.co.revsys.objectology.service.TemplateLoader">
        <constructor-arg index="0" ref="templateService"/>
        <constructor-arg index="1" ref="xmlObjectMapper"/>
    </bean>
    
    <bean id="instanceLoader" class="uk.co.revsys.objectology.service.InstanceLoader">
        <constructor-arg index="0" ref="instanceService"/>
        <constructor-arg index="1" ref="xmlObjectMapper"/>
    </bean>
    
    <bean id="sequenceGenerator" class="uk.co.revsys.objectology.dao.mongo.MongoSequenceGenerator">
        <constructor-arg index="0" ref="mongoClient"/>
        <constructor-arg index="1" value="objectology"/>
        <constructor-arg index="2" value="sequence"/>
    </bean>
    
    <bean id="objectServiceFactory" class="uk.co.revsys.objectology.service.OlogyObjectServiceFactory">
        <property name="ologyTemplateService" ref="templateService"/>
        <property name="ologyInstanceService" ref="instanceService"/>
    </bean>
    
    <bean id="authorisationHandlers" class="java.util.HashMap">
        <constructor-arg index="0">
            <map key-type="java.lang.String" value-type="uk.co.revsys.objectology.security.AuthorisationHandler">
                <entry key="none" value-ref="allowAllAuthorisationHandler"/>
                <entry key="default" value-ref="defaultAuthorisationHandler"/>
            </map>
        </constructor-arg>
    </bean>
    
    <bean id="authorisationHandler" factory-bean="authorisationHandlers" factory-method="get">
        <constructor-arg index="0" value="${security}"/>
    </bean>
    
    <bean id="allowAllAuthorisationHandler" class="uk.co.revsys.objectology.security.AllowAllAuthorisationHandler"/>
    
    <bean id="defaultAuthorisationHandler" class="uk.co.revsys.objectology.security.AuthorisationHandlerImpl">
        <constructor-arg index="0" value="${security.administrator.role}"/>
    </bean>
    
    <bean id="actionHandlerFactory" class="uk.co.revsys.objectology.action.handler.DefaultActionHandlerFactory">
        <constructor-arg index="0" ref="jsonInstanceMapper"/>
    </bean>

</beans>
